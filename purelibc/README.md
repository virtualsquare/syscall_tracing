# purelibc

see [purelibc github repo](https://github.com/virtualsquare/purelibc)

The C library has two roles:

* it provides macro, types and function definitions to help programmers
to generate code for common tasks like string manipulation, file
input/output, etc
e.g. "sprintf" "strlen" or "sqrt" are functions of this type.

* it supplies interface functions to the system calls, so that
C programs can issue system call requests as if it were ordinary
C functions.
e.g. "open", "write", "getpid" are functions of this type

There are functions like "printf" which are "combination" of the two roles.
In some sense printf = sprintf + write.

`purelibc` is an overlay library converting (to some extent) glibc to a pure
C library: when `purelibc` is in use the system calls requests generated by
the user code or by libc functions get redirected to a managing function.

The interface consists of one function `_pure_start`

e.g.
```
static sfun _native_syscall;
...
_native_syscall=_pure_start(mysc,PUREFLAG_STDALL);
```
After this statement syscalls are converted to function calls to mysc.
The implementation of mysc can use the real system calls (those implmented
by the kernel) using _native_syscall.

## Purelibc details:

* self-virtualization

* syscall event notification via: C-library function override (`LD_PRELOAD`)

* multithread safe (it is a function call)

* almost arch independent

* can be "preloaded" for libraries or executables.

* (implementation issue) incomplete interface

## examples:

Note: it needs purelibc

Compile:
```
$ make
```
`puretest_virt` copies the file whose pathname is the first arg to stdout.
```
$ ./puretest_virt /etc/passwd
```
the contents of /etc/hostname will be printed instead

`xchange` works as a preloaded library:
```
make install
LD_PRELOAD=libpurelibc.so:/tmp/xchange.so cat /etc/passwd
```
prints the contents of /etc/hostname

glibc network address translation functions use the file `/etc/resolv.conf` to specify the DNS servers. glibc does not provide any way for a user to specify their own servers.
The example resolvconfx.c shows how purelibs permits users to define a configuration file (instead of `/etc/resolv.conf`).
```
echo nameserver 8.8.8.80 > /tmp/resolv.conf
LD_PRELOAD=libpurelibc.so:/tmp/resolvconfx.so host mad.cs.unibo.it
;; communications error to 8.8.8.80#53: timed out
;; communications error to 8.8.8.80#53: timed out
;; no servers could be reached
```
Note: `/tmp/resolv.conf` refers to a non-existent DNS server (8.8.8.80) on purpose, to
show that the configuration file has been swapped.

### cleaning

```
make uninstall
make clean
```
